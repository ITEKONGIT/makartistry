document.addEventListener("alpine:init",()=>{Alpine.data("productModal",()=>({isOpen:!1,selectedProductKeys:[],searchQuery:"",availableProducts:[],filteredProducts:[],isLoading:!1,init(){console.log("üü° Alpine Modal Init"),this.$watch("searchQuery",()=>this.updateFilteredProducts())},updateFilteredProducts(){if(!Array.isArray(this.availableProducts)){this.filteredProducts=[];return}if(!this.searchQuery||this.searchQuery.trim()===""){this.filteredProducts=[...this.availableProducts];return}const t=this.searchQuery.toLowerCase().trim();this.filteredProducts=this.availableProducts.filter(e=>{const i=(e.name||"").toLowerCase(),s=(e.description||"").toLowerCase(),o=(e.intent_label||e.intent||"").toLowerCase();return i.includes(t)||s.includes(t)||o.includes(t)})},async openModal(){console.log("üö™ Opening modal"),this.isOpen=!0,this.isLoading=!0,this.selectedProductKeys=[],this.searchQuery="",document.body.classList.add("overflow-hidden");try{await this.refreshProducts(),console.log("‚úÖ Products loaded successfully")}catch(t){console.error("‚ùå Failed to load products:",t)}finally{this.isLoading=!1}},closeModal(){console.log("üö™ Closing modal"),this.isOpen=!1,this.selectedProductKeys=[],this.searchQuery="",this.isLoading=!1,document.body.classList.remove("overflow-hidden")},getLivewireComponent(){const t=this.$el.closest("[wire\\:id]");if(t){const e=t.getAttribute("wire:id");if(window.Livewire&&window.Livewire.find)return window.Livewire.find(e)}return typeof window.$wire<"u"?window.$wire:(console.error("‚ùå Could not find Livewire component"),null)},async refreshProducts(){console.log("üîÑ Loading products...");const t=this.getLivewireComponent();if(!t||typeof t.getAvailableProducts!="function")throw new Error("Livewire component not available");const e=await t.getAvailableProducts();return console.log("üì¶ Received products:",e.length),this.availableProducts=Array.isArray(e)?e:[],this.updateFilteredProducts(),e},toggleProduct(t){this.isSelected(t)?this.selectedProductKeys=this.selectedProductKeys.filter(e=>e!==t):this.selectedProductKeys.push(t)},isSelected(t){return this.selectedProductKeys.includes(t)},async addSelectedProducts(){if(this.selectedProductKeys.length===0)return;const t=this.getLivewireComponent();if(t&&typeof t.addMultipleProducts=="function")try{await t.addMultipleProducts(this.selectedProductKeys),console.log("‚úÖ Products added successfully"),this.closeModal()}catch(e){console.error("‚ùå Failed to add products:",e)}}})),Alpine.data("colorThemePicker",t=>({fieldId:t.fieldId,minColors:t.minColors,maxColors:t.maxColors,required:t.required,hasError:t.hasError,selectedColors:[],newColor:"#B37BA4",inputValidationMessage:"",validationMessage:"",hasValidationError:!1,get canAddColor(){return this.isValidHex(this.newColor)&&!this.selectedColors.includes(this.newColor.toUpperCase())&&this.selectedColors.length<this.maxColors},init(){this.loadFromLivewire(),this.$watch("$refs.livewireInput.value",()=>{this.loadFromLivewire()})},loadFromLivewire(){try{const e=this.getLivewireComponent();if(e){const s=e.get(`productConfigurations.${this.fieldId}`);if(Array.isArray(s)){this.selectedColors=s;return}}const i=this.$refs.livewireInput.value;if(i){if(typeof i=="string"&&i.startsWith("[")){const s=JSON.parse(i);if(Array.isArray(s)){this.selectedColors=s;return}}else if(Array.isArray(i)){this.selectedColors=i;return}}}catch(e){console.log("Error loading from Livewire:",e)}this.selectedColors=[]},validateAndPreview(){this.inputValidationMessage="";let e=this.newColor.trim();if(e&&!e.startsWith("#")&&(e="#"+e,this.newColor=e),e&&!this.isValidHex(e)){this.inputValidationMessage="Please enter a valid hex color (e.g., #FF0000)";return}if(e&&this.selectedColors.includes(e.toUpperCase())){this.inputValidationMessage="This color is already selected";return}},addColor(){if(!this.isValidHex(this.newColor)){this.showValidation("Please enter a valid hex color");return}const e=this.newColor.toUpperCase();if(this.selectedColors.includes(e)){this.showValidation("This color is already selected");return}if(this.selectedColors.length>=this.maxColors){this.showValidation(`Maximum ${this.maxColors} colors allowed`);return}this.selectedColors.push(e),this.updateLivewire(),this.hideValidation(),this.inputValidationMessage="",this.newColor="#B37BA4"},removeColor(e){this.selectedColors.splice(e,1),this.updateLivewire(),this.hideValidation()},clearAll(){this.selectedColors=[],this.updateLivewire(),this.hideValidation()},isValidHex(e){return/^#[A-Fa-f0-9]{6}$/.test(e)},updateLivewire(){const e=this.getLivewireComponent();e&&e.set(`productConfigurations.${this.fieldId}`,this.selectedColors),this.$refs.livewireInput.value=JSON.stringify(this.selectedColors),this.$refs.livewireInput.dispatchEvent(new Event("input",{bubbles:!0})),console.log("Updating Livewire:",{fieldId:this.fieldId,colors:this.selectedColors,jsonValue:JSON.stringify(this.selectedColors)})},getLivewireComponent(){const e=this.$el.closest("[wire\\:id]");if(e&&window.Livewire){const i=e.getAttribute("wire:id");return window.Livewire.find(i)}return null},showValidation(e){this.validationMessage=e,this.hasValidationError=!0,setTimeout(()=>this.hideValidation(),3e3)},hideValidation(){this.validationMessage="",this.hasValidationError=!1},getAddButtonTooltip(){return this.isValidHex(this.newColor)?this.selectedColors.includes(this.newColor.toUpperCase())?"Color already selected":this.selectedColors.length>=this.maxColors?`Maximum ${this.maxColors} colors reached`:"Add this color":"Enter a valid hex color"}})),Alpine.data("addonsSelector",t=>({fieldId:t.fieldId,options:t.options||[],minSelections:t.minSelections||0,maxSelections:t.maxSelections,showPrices:t.showPrices,required:t.required,placeholder:t.placeholder,label:t.label,helpText:"{{ $helpText }}",selectedAddons:[],isOpen:!1,focusedIndex:-1,hasValidationError:!1,validationMessage:"",initializeAddons(){const e=this.getLivewire();if(e){const i=e.get(`productConfigurations.${this.fieldId}`)||[];this.selectedAddons=Array.isArray(i)?i:[]}this.validateSelection()},getLivewire(){if(typeof window.Livewire<"u"&&window.Livewire.find){const e=this.$el.closest("[wire\\:id]");if(e){const i=e.getAttribute("wire:id");return window.Livewire.find(i)}}return null},toggleDropdown(){this.isOpen=!this.isOpen,this.isOpen&&(this.focusedIndex=-1)},openDropdown(){this.isOpen=!0,this.focusedIndex=-1},toggleAddon(e){const i=this.selectedAddons.indexOf(e);i>-1?this.selectedAddons.splice(i,1):(!this.maxSelections||this.selectedAddons.length<this.maxSelections)&&this.selectedAddons.push(e),this.updateLivewire(),this.validateSelection()},selectAll(){const e=this.options.slice(0,this.maxSelections||this.options.length);this.selectedAddons=e.map(i=>i.value),this.updateLivewire(),this.validateSelection()},clearAll(){this.selectedAddons=[],this.updateLivewire(),this.validateSelection()},isOptionDisabled(e){return this.maxSelections&&!this.selectedAddons.includes(e)&&this.selectedAddons.length>=this.maxSelections},getDisplayText(){return this.selectedAddons.length===0?this.placeholder:this.selectedAddons.length===1?this.getOptionLabel(this.selectedAddons[0]):`${this.selectedAddons.length} ${this.label.toLowerCase()} selected`},getOptionLabel(e){const i=this.options.find(s=>s.value===e);return i?i.label:e},updateLivewire(){const e=this.getLivewire();e&&e.set(`productConfigurations.${this.fieldId}`,this.selectedAddons)},validateSelection(){this.hasValidationError=!1,this.validationMessage="",this.required&&this.selectedAddons.length<this.minSelections&&(this.hasValidationError=!0,this.validationMessage=this.minSelections>0?`Please select at least ${this.minSelections} ${this.label.toLowerCase()}`:`Please select at least one ${this.label.toLowerCase()}`)},formatPrice(e){return new Intl.NumberFormat("en-NG").format(e)},focusFirstOption(){this.focusedIndex=0,this.focusOption()},focusNextOption(){this.focusedIndex<this.options.length-1&&(this.focusedIndex++,this.focusOption())},focusPreviousOption(){this.focusedIndex>0&&(this.focusedIndex--,this.focusOption())},focusOption(){const e=document.querySelector(`[data-option-index="${this.focusedIndex}"]`);e&&e.focus()},toggleCurrentOption(){if(this.focusedIndex>=0&&this.focusedIndex<this.options.length){const e=this.options[this.focusedIndex];this.toggleAddon(e.value)}}})),Alpine.data("customOrderImageUpload",t=>({productKey:t.productKey,maxFiles:t.maxFiles,maxFileSize:t.maxFileSize,allowedFormats:t.allowedFormats,uploadedImages:[],dragActive:!1,errorMessage:"",currentlyUploading:!1,overallProgress:0,hasError:!1,initializeExistingImages(){const e=this.getLivewireComponent();if(e){const i=e.get(`productConfigurations.${this.productKey}.reference_images`)||[];Array.isArray(i)&&(this.uploadedImages=i.map(s=>({...s,uploading:!1,progress:100})))}},handleFileSelection(e){const i=Array.from(e.target.files);this.processFiles(i),e.target.value=""},handleDragOver(e){e.preventDefault(),this.dragActive=!0},handleDragLeave(e){e.preventDefault(),e.currentTarget.contains(e.relatedTarget)||(this.dragActive=!1)},handleDrop(e){e.preventDefault(),e.stopPropagation(),this.dragActive=!1;const i=Array.from(e.dataTransfer.files);this.processFiles(i)},processFiles(e){if(this.clearError(),this.uploadedImages.length+e.length>this.maxFiles){this.showError(`Cannot upload ${e.length} files. Maximum ${this.maxFiles} images allowed. Currently have ${this.uploadedImages.length}.`);return}const s=e.filter(o=>this.isValidFile(o));s.length!==0&&s.forEach(o=>this.uploadFile(o))},uploadFile(e){this.currentlyUploading=!0;const i={original_name:e.name,size:e.size,uploading:!0,progress:0,preview:null,secure_url:null,public_id:null};this.uploadedImages.push(i);const s=this.uploadedImages.length-1,o=new FileReader;o.onload=r=>{this.uploadedImages[s].preview=r.target.result},o.readAsDataURL(e);const l=this.getLivewireComponent();if(!l){this.showError("Connection error. Please refresh and try again."),this.removeImageByIndex(s);return}l.upload(`productConfigurations.${this.productKey}.reference_images_temp`,e,r=>{this.uploadedImages[s].uploading=!1,this.uploadedImages[s].progress=100,this.checkUploadCompletion(),this.listenForUploadComplete()},r=>{this.showError(`Failed to upload ${e.name}. Please try again.`),this.removeImageByIndex(s),this.checkUploadCompletion()},r=>{this.uploadedImages[s]&&(this.uploadedImages[s].progress=Math.round(r.detail.progress||0),this.updateOverallProgress())})},listenForUploadComplete(){document.addEventListener("image-upload-complete",e=>{e.detail.productKey===this.productKey&&this.initializeExistingImages()})},removeImage(e){this.uploadedImages.splice(e,1),this.updateLivewireData()},removeImageByIndex(e){this.uploadedImages[e]&&this.uploadedImages.splice(e,1)},clearAllImages(){this.uploadedImages=[],this.updateLivewireData()},updateLivewireData(){const e=this.getLivewireComponent();if(e){const i=this.uploadedImages.filter(s=>!s.uploading);e.set(`productConfigurations.${this.productKey}.reference_images`,i)}},checkUploadCompletion(){this.uploadedImages.some(i=>i.uploading)||(this.currentlyUploading=!1,this.overallProgress=0)},updateOverallProgress(){const e=this.uploadedImages.filter(s=>s.uploading);if(e.length===0){this.overallProgress=100;return}const i=e.reduce((s,o)=>s+(o.progress||0),0);this.overallProgress=Math.round(i/e.length)},isValidFile(e){const i=e.name.split(".").pop().toLowerCase();return this.allowedFormats.includes(i)?e.size>this.maxFileSize?(this.showError(`File too large: ${this.formatFileSize(e.size)}. Maximum: ${this.formatFileSize(this.maxFileSize)}`),!1):!0:(this.showError(`Invalid file type: .${i}. Allowed: ${this.allowedFormats.join(", ")}`),!1)},getLivewireComponent(){try{const e=this.$el.closest("[wire\\:id]");if(e){const i=e.getAttribute("wire:id");return window.Livewire.find(i)}}catch(e){console.error("Could not find Livewire component:",e)}return null},showError(e){this.errorMessage=e,this.hasError=!0,setTimeout(()=>this.clearError(),5e3)},clearError(){this.errorMessage="",this.hasError=!1},formatFileSize(e){if(e===0)return"0 B";const i=1024,s=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(i));return parseFloat((e/Math.pow(i,o)).toFixed(1))+" "+s[o]}}))});
